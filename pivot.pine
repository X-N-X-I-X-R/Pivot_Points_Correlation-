//@version=5
indicator("Volume and Pivot Points Correlation with Full Control", shorttitle="Volume Pivot Correlation", overlay=true)

// Inputs for controlling visibility
show_high_pivots = input(true, title="Show High Pivots", inline="High")
show_high_lines = input(true, title="Show Lines", inline="High")
show_high_labels = input(true, title="Show Labels", inline="High")
show_low_pivots = input(true, title="Show Low Pivots", inline="Low")
show_low_lines = input(true, title="Show Lines", inline="Low")
show_low_labels = input(true, title="Show Labels", inline="Low")

// Length and color inputs
lengthGroupTitle = "LENGTH LEFT / RIGHT"
colorGroupTitle = "Text Color / Label Color"
leftLenH = input.int(title="Pivot High", defval=5, minval=1, inline="Pivot High", group=lengthGroupTitle)
rightLenH = input.int(title="/", defval=5, minval=1, inline="Pivot High", group=lengthGroupTitle)
labelColorH = input.color(title="Pivot High Label Color", defval=color.white, inline="Pivot High", group=colorGroupTitle)
lineColorH = input.color(title="Pivot High Line Color", defval=color.rgb(142, 76, 175), inline="Pivot High", group=colorGroupTitle)

leftLenL = input.int(title="Pivot Low", defval=5, minval=1, inline="Pivot Low", group=lengthGroupTitle)
rightLenL = input.int(title="/", defval=5, minval=1, inline="Pivot Low", group=lengthGroupTitle)
labelColorL = input.color(title="Pivot Low Label Color", defval=color.white, inline="Pivot Low", group=colorGroupTitle)
lineColorL = input.color(title="Pivot Low Line Color", defval=color.blue, inline="Pivot Low", group=colorGroupTitle)
backgcolor = input.color(title="Pivot Low Line Color", defval=color.rgb(33, 149, 243, 100), inline="Pivot Low", group=colorGroupTitle)
// Volume calculations
volume_ma_length = input.int(10, title="Volume Moving Average Length")
volume_threshold_factor = input.float(1.5, title="Volume Threshold Factor", minval=1.0)

// Calculate moving average and standard deviation
volume_ma = ta.sma(volume, volume_ma_length)
volume_std_dev = ta.stdev(volume, volume_ma_length)

// Unusual volume conditions
is_unusual_volume_high = volume > (volume_ma + volume_std_dev * volume_threshold_factor)
is_unusual_volume_low = volume < (volume_ma - volume_std_dev * volume_threshold_factor)

// Pivot high and low
pivot_high = ta.pivothigh(high, leftLenH, rightLenH)
pivot_low = ta.pivotlow(low, leftLenL, rightLenL)

// Ranges for pivot extensions
pivot_5_up = pivot_high * 1.05
pivot_10_up = pivot_high * 1.10
pivot_20_up = pivot_high * 1.20
pivot_5_down = pivot_high * 0.95
pivot_10_down = pivot_high * 0.90
pivot_20_down = pivot_high * 0.80

low_5_up = pivot_low * 1.05
low_10_up = pivot_low * 1.10
low_20_up = pivot_low * 1.20
low_5_down = pivot_low * 0.95
low_10_down = pivot_low * 0.90
low_20_down = pivot_low * 0.80

// Draw support and resistance lines with labels for High Pivots
if (show_high_pivots and is_unusual_volume_high and not na(pivot_high)) 
    if (show_high_lines) 
        line.new(x1=bar_index[rightLenH]+ 60 , y1=pivot_10_up, x2=bar_index, y2=pivot_10_up, color=lineColorH, width=2, style=line.style_dotted)
        line.new(x1=bar_index[rightLenH]+ 60, y1=pivot_5_up, x2=bar_index, y2=pivot_5_up, color=lineColorH, width=2, style=line.style_dotted)
        line.new(x1=bar_index[rightLenH]+ 60, y1=pivot_20_up, x2=bar_index, y2=pivot_20_up, color=lineColorH, width=2, style=line.style_dotted)
        line.new(x1=bar_index[rightLenH]+ 60, y1=pivot_10_down, x2=bar_index, y2=pivot_10_down, color=lineColorH, width=2, style=line.style_dotted)
        line.new(x1=bar_index[rightLenH]+ 60, y1=pivot_5_down, x2=bar_index, y2=pivot_5_down, color=lineColorH, width=2, style=line.style_dotted)
        line.new(x1=bar_index[rightLenH]+ 60, y1=pivot_20_down, x2=bar_index, y2=pivot_20_down, color=lineColorH, width=2, style=line.style_dotted)
    

    if (show_high_labels) 
        label.new(bar_index + 55, pivot_10_up, text="War Zone", style=label.style_label_center, color=backgcolor, textcolor=labelColorH, size=size.small)
        label.new(bar_index + 55, pivot_5_up, text="Wait", style=label.style_label_center, color=backgcolor, textcolor=labelColorH, size=size.small)
        label.new(bar_index + 55, pivot_20_up, text="Overbought", style=label.style_label_center, color=backgcolor, textcolor=labelColorH, size=size.small)
        label.new(bar_index + 55, pivot_10_down, text="War Zone", style=label.style_label_center, color=backgcolor, textcolor=labelColorH, size=size.small)
        label.new(bar_index + 55, pivot_5_down, text="Wait", style=label.style_label_center, color=backgcolor, textcolor=labelColorH, size=size.small)
        label.new(bar_index + 55, pivot_20_down, text="Oversold", style=label.style_label_center, color=backgcolor, textcolor=labelColorH, size=size.small)



// Draw support and resistance lines for Low Pivots with labels
if (show_low_pivots and is_unusual_volume_low and not na(pivot_low)) 
    if (show_low_lines) 
        line.new(x1=bar_index[rightLenL]+ 60, y1=low_10_up, x2=bar_index, y2=low_10_up, color=lineColorL, width=2, style=line.style_dotted)
        line.new(x1=bar_index[rightLenL]+ 60, y1=low_5_up, x2=bar_index, y2=low_5_up, color=lineColorL, width=2, style=line.style_dotted)
        line.new(x1=bar_index[rightLenL]+ 60, y1=low_20_up, x2=bar_index, y2=low_20_up, color=lineColorL, width=2, style=line.style_dotted)
        line.new(x1=bar_index[rightLenL]+ 60, y1=low_10_down, x2=bar_index, y2=low_10_down, color=lineColorL, width=2, style=line.style_dotted)
        line.new(x1=bar_index[rightLenL]+ 60, y1=low_5_down, x2=bar_index, y2=low_5_down, color=lineColorL, width=2, style=line.style_dotted)
        line.new(x1=bar_index[rightLenL]+ 60, y1=low_20_down, x2=bar_index, y2=low_20_down, color=lineColorL, width=2, style=line.style_dotted)


    if (show_low_labels) 
        label.new(bar_index+ 55, low_10_up, text="War Zone", style=label.style_label_center, color=backgcolor, textcolor=labelColorL, size=size.small)
        label.new(bar_index+ 55, low_5_up, text="Wait", style=label.style_label_center, color=backgcolor, textcolor=labelColorL, size=size.small)
        label.new(bar_index+ 55, low_20_up, text="Overbought", style=label.style_label_center, color=backgcolor, textcolor=labelColorL, size=size.small)
        label.new(bar_index+ 55, low_10_down, text="War Zone", style=label.style_label_center, color=backgcolor, textcolor=labelColorL, size=size.small)
        label.new(bar_index+ 55, low_5_down, text="Wait", style=label.style_label_center, color=backgcolor, textcolor=labelColorL, size=size.small)
        label.new(bar_index+ 55, low_20_down, text="Oversold", style=label.style_label_center, color=backgcolor, textcolor=labelColorL, size=size.small)


// Highlight pivot high and low levels with lines
if (is_unusual_volume_high and not na(pivot_high)) 
    line.new(x1=bar_index[rightLenH]+ 60, y1=pivot_high, x2=bar_index, y2=pivot_high, color=color.rgb(221, 90, 83), width=2, style=line.style_solid)

if (is_unusual_volume_low and not na(pivot_low))
    line.new(x1=bar_index[rightLenL]+ 60, y1=pivot_low, x2=bar_index, y2=pivot_low, color=color.rgb(148, 212, 122), width=2, style=line.style_solid)

labels = "LR labels"
color_labal = "Text Color / Label Color"
leftP = input.int(title="Pivot High", defval=20, minval=1, inline="Pivot High", group=labels)
rightP = input.int(title="/", defval=20, minval=1, inline="Pivot High", group=labels)
textColorH = input(title="Pivot High", defval=color.rgb(89, 156, 136), inline="Pivot High", group=color_labal)
labelColor = input(title="", defval=color.rgb(89, 156, 136, 100), inline="Pivot High", group=color_labal)

lpivot = input.int(title="Pivot Low", defval=20, minval=1, inline="Pivot Low", group=labels)
rpivot = input.int(title="/", defval=20, minval=1, inline="Pivot Low", group=labels)
textColorL = input(title="Pivot Low", defval=color.rgb(156, 89, 89), inline="Pivot Low", group=color_labal)
labelColorr = input(title="", defval=color.rgb(156, 89, 89,100), inline="Pivot Low", group=color_labal)

ph = ta.pivothigh(leftP, rightP)
pl = ta.pivotlow(lpivot, rpivot)

drawLabel(_offset, _pivot, _style, _color, _textColor) =>
    if not na(_pivot)
        label.new(bar_index[_offset], _pivot, str.tostring(_pivot, format.mintick), style=_style, color=_color, textcolor=_textColor)

drawLabel(rightP, ph, label.style_label_down, labelColorr, textColorH)
drawLabel(rpivot, pl, label.style_label_up, labelColor, textColorL)
